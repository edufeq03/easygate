{% extends 'base.html' %}

{% block title %}Painel do Porteiro{% endblock %}

{% block content %}
<h1 class="mt-4">Bem-vindo, {{ current_user.nome }}!</h1>

<p class="lead">Olá, {{ current_user.nome }}! Seja bem-vindo(a) ao seu painel.</p>

<div class="mb-4">
    <a href="{{ url_for('porteiro.form_cadastrar_profissional') }}" class="btn btn-primary">Cadastrar Novo
        Profissional</a>
    <a href="{{ url_for('porteiro.consultar_profissional') }}" class="btn btn-success">Consultar Profissional</a>
</div>

<hr>

<h2>Solicitações de Entrada (Via QR Code)</h2>
{% if solicitacoes_qr_code %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Profissional</th>
                <th>Horário da Solicitação</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="solicitacoes-qr-code-body">
            {% for acesso in solicitacoes_qr_code %}
            <tr id="acesso-row-{{ acesso.id }}">
                <td>{{ acesso.profissional.nome }}</td>
                <td>
                    {% if acesso.data_acesso %}
                    {{ acesso.data_acesso.strftime('%H:%M:%S') }}
                    {% else %}
                    N/A
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('porteiro.registrar_entrada_manual', acesso_id=acesso.id) }}"
                        class="btn btn-sm btn-success">Autorizar Entrada</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p id="no-solicitacoes-message" class="alert alert-info">Nenhuma solicitação de entrada via QR Code pendente.</p>
{% endif %}

<hr>

...

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const socket = io();
        // Agora, use o ID da portaria do usuário logado, não o do condomínio
        const portariaId = "{{ current_user.portaria.id }}";
        const solicitacoesBody = document.getElementById('solicitacoes-qr-code-body');
        const noSolicitacoesMessage = document.getElementById('no-solicitacoes-message');

        socket.on('connect', function() {
            console.log('Conectado ao SocketIO! ID da sessão:', socket.id);
            // O cliente entra na sala específica da sua portaria
            const roomName = 'porteiro_dashboard_' + portariaId;
            socket.emit('join', { room: roomName });
            console.log('Entrando na sala:', roomName);
        });
        
        // ... (o resto do código do SocketIO é o mesmo) ...
        socket.on('nova_solicitacao_acesso', function(data) {
            // ... (código existente para criar a linha) ...
        });
    });
</script>
{% endblock %}
{% endblock %}